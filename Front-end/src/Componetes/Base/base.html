{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}HuMap{% endblock %}</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'Componetes/Base/common_layout.css' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>

    <div id="notif-box" class="notif-box">
        <p>üöß Rua com buraco ‚Äî Rua Safira</p>
        <p>‚ö†Ô∏è Falta de ilumina√ß√£o ‚Äî Rua Top√°zio</p>
        <p>üö® Assalto recente ‚Äî Avenida Atl√¢ntica</p>
        <p>üî• Perigo agora ‚Äî Rua Esmeralda</p>
    </div>

    <div class="main-sidebar" id="sidebarMenu">
        <div class="list-group">
            <a href="{% url 'core:feed' %}" class="list-group-item">
                <span class="material-icons-outlined">dashboard</span> Feed
            </a>
            <a href="{% url 'users:perfil' %}" class="list-group-item"> 
                <span class="material-icons-outlined">person_outline</span> Perfil
            </a>
            <a href="{% url 'core:configuracao' %}" class="list-group-item">
                <span class="material-icons-outlined">settings</span> Configura√ß√µes
            </a>
            <a href="{% url 'core:suporte' %}" class="list-group-item">
                <span class="material-icons-outlined">help_outline</span> Suporte
            </a>
            <a href="{% url 'sobre_nos' %}" class="list-group-item">
                <span class="material-icons-outlined">people_outline</span> Sobre n√≥s
            </a>
            <a href="{% url 'core:tutorial' %}" class="list-group-item">
                <span class="material-icons-outlined">menu</span> Tutorial
            </a>
        </div>
        <button id="btn-close" class="sidebar-close-btn">
            <span class="material-icons-outlined">logout</span> Sair
        </button>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <nav class="main-navbar">
        <button id="menuToggleBtn"> 
            <span class="material-icons-outlined">menu</span>
        </button>

        <button class="user-profile-btn" onclick="window.location.href='{% url 'users:perfil' %}'"> 
            {% if user.foto %}
                <img src="{{ user.foto.url }}" alt="Perfil" class="profile-img" id="header-user-avatar"/>
            {% else %}
                <img src="{% static 'assets/perf.jpg' %}" alt="Perfil" class="profile-img" id="header-user-avatar"/>
            {% endif %}
            <p>Ol√°, {{ user.first_name|default:'Usu√°rio' }}!</p>
        </button>

        <div class="search-area">
            <input type="text" id="searchInput" placeholder="Pesquisar cidade ou CEP..." oninput="realizarBusca()" onkeypress="verificarEnter(event)" autocomplete="off"/>
            
            <button class="search-btn" onclick="buscarEIr()">
                <img src="https://cdn-icons-png.flaticon.com/512/54/54481.png" alt="Buscar" />
            </button>
            
            <div id="suggestions" class="suggestions-box"></div>
        </div>

        <div class="notify-area">
            <button id="notifyBtn" class="notify-btn">
                <img src="{% static 'assets/Notificacao.png' %}" alt="Notifica√ß√µes"/>
            </button>
        </div>
    </nav>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-col">
                <h1 class="footer-logo">HuMap</h1>
                <p>Conectando pessoas, ideias e solu√ß√µes.</p>
            </div>
            
            <div class="footer-col">
                <h2>Navega√ß√£o</h2>
                <ul>
                    <li><a href="{% url 'core:home' %}">In√≠cio</a></li>
                    <li><a href="{% url 'sobre_nos' %}">Sobre</a></li>
                    <li><a href="{% url 'core:tutorial' %}">Tutorial</a></li>
                    <li><a href="{% url 'core:suporte' %}">Suporte</a></li>
                </ul>
            </div>
            
            <div class="footer-col">
                <h2>Contato</h2>
                <p>humap@projeto.com</p>
                <p>Recife - PE</p>
            </div>
        </div>
        
        <div class="copyright-copy">
            ¬© 2025 HuMap ‚Äî Todos os direitos reservados.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    {% block base_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- VARI√ÅVEIS ---
            const menuToggleBtn = document.getElementById("menuToggleBtn");
            const sidebarMenu = document.getElementById("sidebarMenu");
            const sidebarOverlay = document.getElementById("sidebarOverlay");
            const btnCloseSidebar = document.getElementById("btn-close");
            const notifBox = document.getElementById("notif-box");
            const notifyBtn = document.getElementById("notifyBtn");
            
            const searchInput = document.getElementById("searchInput");
            const suggestionsBox = document.getElementById("suggestions");
            let debounceTimer;

            // --- L√ìGICA DE PESQUISA INTELIGENTE ---
            
            window.realizarBusca = function() {
                const query = searchInput.value.trim();
                
                if (query.length < 3) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                clearTimeout(debounceTimer);
                
                debounceTimer = setTimeout(async () => {
                    suggestionsBox.style.display = 'block';
                    suggestionsBox.innerHTML = '<p style="padding:10px; color:#666;">Buscando...</p>';

                    // 1. BUSCA POR CEP (8 D√≠gitos)
                    const cepApenasNumeros = query.replace(/\D/g, '');
                    if (cepApenasNumeros.length === 8) {
                        buscarCEP(cepApenasNumeros);
                        return;
                    }

                    // 2. BUSCA POR TEXTO (Cidade/Rua) - Nominatim
                    buscarTexto(query);

                }, 500);
            };

            async function buscarCEP(cep) {
                try {
                    const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await resp.json();
                    
                    if (!data.erro) {
                        const enderecoCompleto = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
                        
                        suggestionsBox.innerHTML = `
                            <div class="suggestion-item" onclick="selecionarLocalPeloTexto('${enderecoCompleto}')">
                                <strong>üìç ${data.localidade} - ${data.uf}</strong><br>
                                <small>CEP: ${data.cep}</small><br>
                                <small style="color:#888;">${data.logradouro}</small>
                            </div>
                        `;
                    } else {
                        suggestionsBox.innerHTML = '<p style="padding:10px;">CEP n√£o encontrado.</p>';
                    }
                } catch (e) {
                    suggestionsBox.innerHTML = '<p style="padding:10px;">Erro ao buscar CEP.</p>';
                }
            }

            async function buscarTexto(query) {
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=br&limit=5&addressdetails=1`);
                    const results = await resp.json();

                    if (results.length === 0) {
                        suggestionsBox.innerHTML = '<p style="padding:10px;">Local n√£o encontrado.</p>';
                        return;
                    }

                    suggestionsBox.innerHTML = results.map(place => {
                        const info = formatarEndereco(place.address);
                        return `
                            <div class="suggestion-item" onclick="selecionarCoordenadas(${place.lat}, ${place.lon}, '${info.nomePrincipal}')">
                                <strong>üìç ${info.nomePrincipal}</strong><br>
                                <small>${info.detalhes}</small>
                            </div>
                        `;
                    }).join('');

                } catch (e) {
                    console.error(e);
                    suggestionsBox.innerHTML = '<p style="padding:10px;">Erro na conex√£o.</p>';
                }
            }

            function formatarEndereco(address) {
                const cidade = address.city || address.town || address.village || address.municipality || address.county || '';
                const estado = address.state || '';
                const cep = address.postcode ? `CEP: ${address.postcode}` : '';
                
                let nomePrincipal = cidade;
                if (address.road) nomePrincipal = address.road;

                let partes = [];
                if (address.road && cidade) partes.push(cidade);
                if (estado) partes.push(estado);
                if (cep) partes.push(cep);

                return {
                    nomePrincipal: nomePrincipal || "Local sem nome",
                    detalhes: partes.join(' - ')
                };
            }

            window.buscarEIr = async function() {
                const query = searchInput.value.trim();
                if(!query) return alert("Digite algo para buscar.");

                suggestionsBox.style.display = 'none';

                const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=br&limit=1`);
                const data = await resp.json();

                if (data.length > 0) {
                    const place = data[0];
                    window.selecionarCoordenadas(place.lat, place.lon, place.display_name);
                } else {
                    alert("Local n√£o encontrado no mapa.");
                }
            };

            window.verificarEnter = function(e) {
                if (e.key === 'Enter') window.buscarEIr();
            };

            window.selecionarCoordenadas = function(lat, lon, nome) {
                searchInput.value = nome.split(',')[0];
                suggestionsBox.style.display = 'none';

                if (typeof map !== 'undefined' && map) {
                    map.setView([lat, lon], 16);
                    L.popup()
                        .setLatLng([lat, lon])
                        .setContent(`<b>${nome}</b>`)
                        .openOn(map);
                } else {
                    alert("V√° para a p√°gina inicial para ver este local no mapa.");
                }
            };

            window.selecionarLocalPeloTexto = async function(endereco) {
                searchInput.value = endereco.split(',')[0];
                suggestionsBox.innerHTML = '<p style="padding:10px;">Carregando mapa...</p>';
                
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${endereco}&countrycodes=br&limit=1`);
                    const data = await resp.json();
                    
                    if (data.length > 0) {
                        window.selecionarCoordenadas(data[0].lat, data[0].lon, endereco);
                    } else {
                        suggestionsBox.style.display = 'none';
                        alert("Endere√ßo encontrado, mas sem coordenadas precisas.");
                    }
                } catch (e) {
                    suggestionsBox.style.display = 'none';
                }
            };

            document.body.addEventListener('click', () => {
                suggestionsBox.style.display = 'none';
            });
            const searchArea = document.querySelector('.search-area');
            if (searchArea) searchArea.addEventListener('click', (e) => e.stopPropagation());

            // --- MENU LATERAL (Mantido igual) ---
            window.closeMenuNotification = function() { if (notifBox) notifBox.classList.remove("open"); }
            window.openMenu = function() {
                if (sidebarMenu) sidebarMenu.classList.add("active");
                if (sidebarOverlay) { sidebarOverlay.style.display = "block"; setTimeout(() => sidebarOverlay.classList.add("active"), 10); }
                document.body.style.overflow = "hidden";
            }
            window.closeMenu = function() {
                if (sidebarMenu) sidebarMenu.classList.remove("active");
                if (sidebarOverlay) sidebarOverlay.classList.remove("active");
                document.body.style.overflow = "";
                setTimeout(() => { if (sidebarOverlay && !sidebarMenu.classList.contains("active")) sidebarOverlay.style.display = "none"; }, 300); 
            }
            if (menuToggleBtn) menuToggleBtn.onclick = function () {
                if (sidebarMenu.classList.contains("active")) window.closeMenu();
                else { window.closeMenuNotification(); window.openMenu(); }
            };
            if (btnCloseSidebar) btnCloseSidebar.onclick = function() {
                window.closeMenu();
                setTimeout(function() { window.location.href = '{% url "users:logout" %}'; }, 100); 
            };
            if (sidebarOverlay) sidebarOverlay.addEventListener("click", window.closeMenu);
            document.querySelectorAll(".main-sidebar .list-group-item").forEach((item) => { item.addEventListener("click", window.closeMenu); });
            if (notifyBtn) notifyBtn.onclick = (e) => {
                e.stopPropagation(); window.closeMenu(); if (notifBox) notifBox.classList.toggle("open");
            };
            if (notifBox) notifBox.onclick = (e) => e.stopPropagation();
            document.body.onclick = () => { window.closeMenuNotification(); suggestionsBox.style.display = 'none'; };
        });
    </script>
    {% endblock %}
    
    {% block extra_js %}{% endblock %}

</body>
</html>